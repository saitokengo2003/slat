<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>グループ一覧</title>

    <link rel="icon" th:href="@{/images/logo.png}" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/groupinfo.css" />
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      thead {
        background: #f8f8f8;
      }
      .dim {
        opacity: 0.7;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid p-0 d-flex">
      <main class="main-content container py-4">
        <!-- メッセージ -->
        <p class="text-danger" th:if="${errorMessage}" th:text="${errorMessage}"></p>
        <p class="text-success" th:if="${message}" th:text="${message}"></p>

        <!-- ▼ 詳細モード：group がある時だけ描画 -->
        <section th:if="${group != null}">
          <div class="group-header mb-3">
            <h1 th:text="${group.name}">グループ詳細</h1>
            <p>
              作成者:
              <span th:text="${group.created_by}">owner</span>
              / 作成日:
              <!-- まずは生の値をそのまま表示（フォーマット無し） -->
              <span th:text="${group.created_at}">-</span>
            </p>
          </div>

          <table class="group-table mb-4">
            <thead>
              <tr>
                <th>ユーザー名</th>
                <th>表示名</th>
                <th>ロール</th>
                <th>グループ内ロール</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="m : ${members}">
                <td th:text="${m.user_id}">username</td>
                <td th:text="${m.display_name}">表示名</td>
                <td th:text="${m.role_code}">student</td>
                <td th:text="${m.role_in_group}">member</td>
                <td>
                  <!-- オーナーは削除不可／表示だけ -->
                  <span th:if="${m.role_in_group == 'owner'}" class="text-muted small"
                    >オーナー</span
                  >
                  <form
                    th:if="${m.role_in_group != 'owner'}"
                    th:action="@{/group/{gid}/member/{uid}/delete(gid=${group.id}, uid=${m.user_id})}"
                    method="post"
                    class="d-inline"
                    onsubmit="return confirm('このメンバーをグループから削除しますか？');"
                  >
                    <button type="submit" class="btn btn-sm btn-outline-danger">削除</button>
                  </form>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(members)}">
                <td colspan="4" class="dim">メンバーがいません</td>
              </tr>
            </tbody>
          </table>

          <div class="mb-4">
            <h2 class="h5">メンバー追加</h2>
            <form
              th:action="@{/group/{id}/member/add(id=${group.id})}"
              method="post"
              class="row g-2 align-items-center"
            >
              <div class="col-auto">
                <select class="form-select" name="userId" required>
                  <option value="" selected disabled>ユーザーを選択...</option>
                  <option
                    th:each="a : ${accounts}"
                    th:value="${a.username}"
                    th:text="${a.display_name + ' (' + a.username + ')'}"
                  >
                    user
                  </option>
                </select>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-primary">追加</button>
              </div>
            </form>
          </div>

          <div class="mb-3">
            <a class="btn btn-outline-secondary" th:href="@{/groupinfo}">一覧に戻る</a>
            <form
              th:action="@{/group/{id}/delete(id=${group.id})}"
              method="post"
              class="d-inline"
              onsubmit="return confirm('このグループを削除します。よろしいですか？');"
            >
              <button type="submit" class="btn btn-danger">削除</button>
            </form>
          </div>
        </section>

        <!-- ▼ 一覧モード：group が無い時に描画 -->
        <section th:if="${group == null}">
          <div class="group-header mb-3">
            <h1>グループ一覧</h1>
          </div>

          <table class="group-table">
            <thead>
              <tr>
                <th>名前</th>
                <th>作成者</th>
                <th>作成日</th>
                <th>メンバー数</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="g : ${groups}">
                <td th:text="${g.name}">グループ名</td>
                <td th:text="${g.created_by}">owner</td>
                <!-- まずはフォーマットせず生の created_at を表示 -->
                <td th:text="${g.created_at}">-</td>
                <td th:text="${g.member_count}">0</td>
                <td>
                  <a class="btn btn-sm btn-primary" th:href="@{/groupinfo/{id}(id=${g.id})}"
                    >詳細</a
                  >

                  <!-- グループ削除ボタン（一覧画面） -->
                  <form
                    th:action="@{/group/{id}/delete(id=${g.id})}"
                    method="post"
                    class="d-inline"
                    onsubmit="return confirm('本当に削除しますか？');"
                  >
                    <button type="submit" class="btn btn-sm btn-danger">削除</button>
                  </form>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(groups)}">
                <td colspan="5" class="dim">グループがありません</td>
              </tr>
            </tbody>
          </table>
        </section>
      </main>
    </div>

    <!-- ✅ JS -->
    <script th:src="@{/js/main.js}"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let deleteTarget = null;
        const modal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));
        const confirmBtn = document.getElementById("confirmDeleteBtn");

        // 🗑️ ボタンが押されたらモーダル表示
        document.querySelectorAll(".action-btn.delete").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            deleteTarget = btn; // 押されたボタンを記録
            modal.show();
          });
        });

        // 「削除する」ボタンが押されたら実行
        confirmBtn.addEventListener("click", () => {
          modal.hide();
          // ここに実際の削除処理を記述（今は例として削除完了メッセージ）
          alert("削除しました。");

          // 実際に削除したい場合（例：行を消す）
          const row = deleteTarget.closest("tr");
          row.remove();
        });
      });
    </script>
  </body>
</html>
